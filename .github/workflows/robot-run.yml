name: Robot Framework Automated API Tests

on:
  push:
    paths:
      - 'tests/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install robotframework robotframework-requests requests

      - name: Create Custom InfluxDB Listener
        run: |
          cat <<EOF > influx_listener.py
          import requests
          import time

          class influx_listener:
              ROBOT_LISTENER_API_VERSION = 2

              def __init__(self, url, token, org, bucket):
                  self.url = f"{url}/api/v2/write?org={org}&bucket={bucket}&precision=s"
                  self.headers = {"Authorization": f"Token {token}", "Content-Type": "text/plain; charset=utf-8"}

              def end_test(self, name, attrs):
                  status = 1 if attrs['status'] == 'PASS' else 0
                  duration = attrs['elapsedtime'] / 1000.0
                  # Line Protocol format
                  data = f"test_cases,test_name={name.replace(' ', '_')},project=ecommerce status={status},duration={duration}"
                  try:
                      requests.post(self.url, headers=self.headers, data=data, timeout=5)
                  except Exception as e:
                      print(f"Failed to send data to InfluxDB: {e}")
          EOF

      - name: Run Robot Framework Tests
        run: |
          mkdir -p results
          # ใช้เครื่องหมาย ; แทน : ในการส่ง arguments ให้ listener
          robot -d results \
          --listener "influx_listener.py;https://a0a7-131-229-247-58.ngrok-free.app;-5BwTjLE1hJxif2RJbjuuiBt_W0q1_cWP9CI5AZcp9CwY595hXVHF7O-hA8gpzbO6wW7m54KkIVSdZ2-sy7IyA==;my-org;robot-metrics" \
          tests/**/*.robot

      - name: Upload Test Results
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: robot-test-results
          path: results/